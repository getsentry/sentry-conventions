---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import PiiBadge from '../../../components/PiiBadge.astro';
import TypeBadge from '../../../components/TypeBadge.astro';
import { getCollection } from 'astro:content';
import { parseAttributeId } from '../../../utils/category';

export async function getStaticPaths() {
  const allAttributes = await getCollection('attributes');

  return allAttributes.map((attr) => {
    const { category, slug } = parseAttributeId(attr.id);
    
    return {
      params: { category, slug },
      props: { attribute: attr },
    };
  });
}

interface Props {
  attribute: Awaited<ReturnType<typeof getCollection<'attributes'>>>[number];
}

const { category, slug } = Astro.params;
const { attribute } = Astro.props;
const attr = attribute.data;
const isDeprecated = !!attr.deprecation;

// Raw JSON for the toggle view
const rawJson = JSON.stringify(attr, null, 2);
---

<BaseLayout 
  title={attr.key} 
  description={attr.brief}
>
  <div class="max-w-4xl">
    <nav class="breadcrumb">
      <a href={`${import.meta.env.BASE_URL}attributes/`}>Attributes</a>
      <span class="separator">/</span>
      <a href={`${import.meta.env.BASE_URL}attributes/${category}/`}>{category}</a>
      <span class="separator">/</span>
      <span class="current font-mono text-xs">{attr.key}</span>
    </nav>
    
    <header class="mb-8 pb-6 border-b border-border">
      <div class="flex flex-wrap items-start justify-between gap-4 mb-4">
        <h1 class="flex items-center gap-3 m-0 text-2xl">
          <code class="text-2xl p-0 bg-transparent border-none text-accent">{attr.key}</code>
          {isDeprecated && <span class="badge badge-deprecated">Deprecated</span>}
        </h1>
        <div class="flex bg-bg-secondary border border-border rounded-md overflow-hidden">
          <button class="toggle-btn active flex items-center gap-2 px-3 py-2 bg-transparent border-none text-text-muted text-sm font-sans cursor-pointer transition-all duration-fast hover:text-text-secondary hover:bg-bg-hover" data-view="pretty" type="button">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7" rx="1"/>
              <rect x="14" y="3" width="7" height="7" rx="1"/>
              <rect x="14" y="14" width="7" height="7" rx="1"/>
              <rect x="3" y="14" width="7" height="7" rx="1"/>
            </svg>
            <span>Prettified</span>
          </button>
          <button class="toggle-btn flex items-center gap-2 px-3 py-2 bg-transparent border-none text-text-muted text-sm font-sans cursor-pointer transition-all duration-fast hover:text-text-secondary hover:bg-bg-hover" data-view="raw" type="button">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="16,18 22,12 16,6"/>
              <polyline points="8,6 2,12 8,18"/>
            </svg>
            <span>Raw JSON</span>
          </button>
        </div>
      </div>
      
      <div class="flex flex-wrap gap-2 mb-4">
        <TypeBadge type={attr.type} />
        <PiiBadge pii={attr.pii.key} reason={attr.pii.reason} />
        {attr.is_in_otel && (
          <span class="badge badge-otel" title="Defined in OpenTelemetry Semantic Conventions">OTel</span>
        )}
        {attr.has_dynamic_suffix && (
          <span class="badge badge-dynamic" title="This attribute has a dynamic suffix">Dynamic</span>
        )}
      </div>
      
      <p class="text-lg text-text-secondary m-0 leading-relaxed">{attr.brief}</p>
    </header>
    
    <!-- Prettified View -->
    <div class="view-content pretty-view active" id="pretty-view">
      <table class="w-full border-collapse bg-bg-secondary border border-border rounded-lg overflow-hidden m-0">
        <tbody>
          <tr class="border-b border-border hover:bg-bg-hover">
            <td class="w-40 py-3 px-4 font-mono text-sm font-medium text-text-muted bg-bg-elevated border-r border-border align-top">type</td>
            <td class="py-3 px-4 text-sm text-text-secondary">
              <span class="inline-block px-2 py-0.5 bg-accent-soft text-accent rounded-sm font-mono text-sm">{attr.type}</span>
            </td>
          </tr>
          
          <tr class="border-b border-border hover:bg-bg-hover">
            <td class="w-40 py-3 px-4 font-mono text-sm font-medium text-text-muted bg-bg-elevated border-r border-border align-top">pii</td>
            <td class="py-3 px-4 text-sm text-text-secondary">
              <span class:list={[
                "inline-block px-2 py-0.5 rounded-sm font-mono text-sm font-medium",
                attr.pii.key === 'true' ? 'bg-pii-true/15 text-pii-true' : 
                attr.pii.key === 'maybe' ? 'bg-pii-maybe/15 text-pii-maybe' : 
                'bg-pii-false/15 text-pii-false'
              ]}>{attr.pii.key}</span>
              {attr.pii.reason && (
                <span class="text-text-muted text-sm ml-2">â€” {attr.pii.reason}</span>
              )}
            </td>
          </tr>
          
          <tr class="border-b border-border hover:bg-bg-hover">
            <td class="w-40 py-3 px-4 font-mono text-sm font-medium text-text-muted bg-bg-elevated border-r border-border align-top">is_in_otel</td>
            <td class="py-3 px-4 text-sm text-text-secondary">
              <span class:list={[
                "inline-block px-2 py-0.5 rounded-sm font-mono text-sm font-medium",
                attr.is_in_otel ? 'bg-success/15 text-success' : 'bg-error/15 text-error'
              ]}>
                {attr.is_in_otel ? 'true' : 'false'}
              </span>
            </td>
          </tr>
          
          {attr.has_dynamic_suffix !== undefined && (
            <tr class="border-b border-border hover:bg-bg-hover">
              <td class="w-40 py-3 px-4 font-mono text-sm font-medium text-text-muted bg-bg-elevated border-r border-border align-top">has_dynamic_suffix</td>
              <td class="py-3 px-4 text-sm text-text-secondary">
                <span class:list={[
                  "inline-block px-2 py-0.5 rounded-sm font-mono text-sm font-medium",
                  attr.has_dynamic_suffix ? 'bg-success/15 text-success' : 'bg-error/15 text-error'
                ]}>
                  {attr.has_dynamic_suffix ? 'true' : 'false'}
                </span>
              </td>
            </tr>
          )}
          
          {attr.example !== undefined && (
            <tr class="border-b border-border hover:bg-bg-hover">
              <td class="w-40 py-3 px-4 font-mono text-sm font-medium text-text-muted bg-bg-elevated border-r border-border align-top">example</td>
              <td class="py-3 px-4 text-sm text-text-secondary">
                {Array.isArray(attr.example) ? (
                  <span class="inline-flex flex-wrap gap-2">
                    {attr.example.map((item, i) => (
                      <code class="text-sm text-code-string bg-bg-elevated px-2 py-0.5 rounded-sm">{typeof item === 'string' ? `"${item}"` : String(item)}</code>
                    ))}
                  </span>
                ) : typeof attr.example === 'string' ? (
                  <code class="text-sm text-code-string">"{attr.example}"</code>
                ) : (
                  <code class="text-sm text-code-number">{String(attr.example)}</code>
                )}
              </td>
            </tr>
          )}
          
          {attr.alias && attr.alias.length > 0 && (
            <tr class="border-b border-border hover:bg-bg-hover">
              <td class="w-40 py-3 px-4 font-mono text-sm font-medium text-text-muted bg-bg-elevated border-r border-border align-top">alias</td>
              <td class="py-3 px-4 text-sm text-text-secondary">
                <span class="inline-flex flex-wrap gap-2">
                  {attr.alias.map((a) => (
                    <code class="text-sm text-code-string bg-bg-elevated px-2 py-0.5 rounded-sm">"{a}"</code>
                  ))}
                </span>
              </td>
            </tr>
          )}
          
          {attr.sdks && attr.sdks.length > 0 && (
            <tr class="border-b border-border last:border-b-0 hover:bg-bg-hover">
              <td class="w-40 py-3 px-4 font-mono text-sm font-medium text-text-muted bg-bg-elevated border-r border-border align-top">sdks</td>
              <td class="py-3 px-4 text-sm text-text-secondary">
                <span class="inline-flex flex-wrap gap-2">
                  {attr.sdks.map((sdk) => (
                    <span class="px-2 py-0.5 bg-bg-elevated border border-border rounded-sm text-sm text-text-secondary">{sdk}</span>
                  ))}
                </span>
              </td>
            </tr>
          )}
        </tbody>
      </table>
      
      {attr.deprecation && (
        <div class="mt-6">
          <h3 class="text-sm font-semibold text-error mb-3 uppercase tracking-wider">Deprecation</h3>
          <table class="w-full border-collapse bg-bg-secondary border border-error/30 rounded-lg overflow-hidden m-0">
            <tbody>
              {attr.deprecation.replacement && (
                <tr class="border-b border-border hover:bg-bg-hover">
                  <td class="w-40 py-3 px-4 font-mono text-sm font-medium text-text-muted bg-error/5 border-r border-border align-top">replacement</td>
                  <td class="py-3 px-4 text-sm text-text-secondary">
                    <a href={`${import.meta.env.BASE_URL}attributes/${category}/${attr.deprecation.replacement.replace(/\./g, '__')}/`} class="text-accent hover:underline">
                      <code class="text-sm bg-transparent p-0 border-none">{attr.deprecation.replacement}</code>
                    </a>
                  </td>
                </tr>
              )}
              {attr.deprecation.reason && (
                <tr class="border-b border-border hover:bg-bg-hover">
                  <td class="w-40 py-3 px-4 font-mono text-sm font-medium text-text-muted bg-error/5 border-r border-border align-top">reason</td>
                  <td class="py-3 px-4 text-sm text-text-secondary leading-relaxed">{attr.deprecation.reason}</td>
                </tr>
              )}
              <tr class="hover:bg-bg-hover">
                <td class="w-40 py-3 px-4 font-mono text-sm font-medium text-text-muted bg-error/5 border-r border-border align-top">_status</td>
                <td class="py-3 px-4 text-sm text-text-secondary">
                  <span class:list={[
                    "inline-block px-2 py-0.5 rounded-sm font-mono text-sm",
                    attr.deprecation._status ? 'bg-warning/15 text-warning' : 'text-text-muted bg-bg-elevated'
                  ]}>
                    {attr.deprecation._status ?? 'null'}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      )}
    </div>
    
    <!-- Raw JSON View -->
    <div class="view-content raw-view hidden" id="raw-view">
      <div class="relative">
        <button class="copy-btn absolute top-3 right-3 flex items-center gap-2 px-3 py-2 bg-bg-secondary border border-border rounded-md text-text-muted text-xs font-sans cursor-pointer transition-all duration-fast z-10 hover:text-text-secondary hover:border-border-light" type="button" title="Copy JSON">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
            <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
          </svg>
          <span>Copy</span>
        </button>
        <pre class="m-0 p-6 pt-16 bg-bg-secondary border border-border rounded-lg overflow-x-auto"><code class="json-code text-sm leading-relaxed text-text-secondary">{rawJson}</code></pre>
      </div>
    </div>
    
    <!-- Back link -->
    <div class="mt-8 pt-6 border-t border-border">
      <a href={`${import.meta.env.BASE_URL}attributes/${category}/`} class="inline-flex items-center gap-2 text-sm text-text-secondary transition-colors duration-fast hover:text-accent">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Back to {category} attributes
      </a>
    </div>
  </div>
</BaseLayout>

<script>
  // View toggle functionality
  const toggleBtns = document.querySelectorAll('.toggle-btn');
  const prettyView = document.getElementById('pretty-view');
  const rawView = document.getElementById('raw-view');
  
  toggleBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const view = btn.getAttribute('data-view');
      
      // Update button states
      toggleBtns.forEach(b => {
        b.classList.remove('active');
        b.classList.remove('text-accent', 'bg-accent-soft');
        b.classList.add('text-text-muted');
      });
      btn.classList.add('active', 'text-accent', 'bg-accent-soft');
      btn.classList.remove('text-text-muted');
      
      // Update view visibility
      if (view === 'pretty') {
        prettyView?.classList.remove('hidden');
        rawView?.classList.add('hidden');
      } else {
        prettyView?.classList.add('hidden');
        rawView?.classList.remove('hidden');
      }
    });
  });

  // Initialize active state
  document.querySelector('.toggle-btn.active')?.classList.add('text-accent', 'bg-accent-soft');
  document.querySelector('.toggle-btn.active')?.classList.remove('text-text-muted');
  
  // Copy button functionality
  const copyBtn = document.querySelector('.copy-btn');
  const jsonCode = document.querySelector('.json-code');
  
  copyBtn?.addEventListener('click', async () => {
    const text = jsonCode?.textContent;
    if (text) {
      await navigator.clipboard.writeText(text);
      const span = copyBtn.querySelector('span');
      if (span) {
        span.textContent = 'Copied!';
        setTimeout(() => {
          span.textContent = 'Copy';
        }, 2000);
      }
    }
  });
</script>
