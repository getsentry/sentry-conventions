---
import BaseLayout from '../../layouts/BaseLayout.astro';
import AttributeCard from '../../components/AttributeCard.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allAttributes = await getCollection('attributes');
  
  // Build category map
  const categoryMap = new Map<string, typeof allAttributes>();
  
  for (const attr of allAttributes) {
    const parts = attr.id.split('/');
    const category = parts.length > 1 ? parts[0] : 'general';
    
    if (!categoryMap.has(category)) {
      categoryMap.set(category, []);
    }
    categoryMap.get(category)!.push(attr);
  }
  
  // Generate paths for each category
  return Array.from(categoryMap.entries()).map(([category, attributes]) => ({
    params: { category },
    props: { attributes, allCategories: Array.from(categoryMap.keys()).sort() },
  }));
}

interface Props {
  attributes: Awaited<ReturnType<typeof getCollection<'attributes'>>>;
  allCategories: string[];
}

const { category } = Astro.params;
const { attributes, allCategories } = Astro.props;

// Sort attributes: stable first, then deprecated, both alphabetically
const stableAttributes = attributes
  .filter(a => !a.data.deprecation)
  .sort((a, b) => a.data.key.localeCompare(b.data.key));

const deprecatedAttributes = attributes
  .filter(a => a.data.deprecation)
  .sort((a, b) => a.data.key.localeCompare(b.data.key));

const totalCount = attributes.length;
const stableCount = stableAttributes.length;
const deprecatedCount = deprecatedAttributes.length;

// Format category name for display
const categoryTitle = category!.charAt(0).toUpperCase() + category!.slice(1);
---

<BaseLayout 
  title={`${categoryTitle} Attributes`} 
  description={`Browse ${totalCount} ${category} attributes in Sentry semantic conventions`}
>
  <nav class="breadcrumb">
    <a href={`${import.meta.env.BASE_URL}attributes/`}>Attributes</a>
    <span class="separator">/</span>
    <span class="current">{category}</span>
  </nav>
  
  <div class="page-header">
    <h1>{categoryTitle} Attributes</h1>
    <p class="page-description">
      {totalCount} attribute{totalCount !== 1 ? 's' : ''} in this category.
      {stableCount > 0 && <span class="stat-stable">{stableCount} stable</span>}
      {stableCount > 0 && deprecatedCount > 0 && <span class="stat-separator">Â·</span>}
      {deprecatedCount > 0 && <span class="stat-deprecated">{deprecatedCount} deprecated</span>}
    </p>
  </div>
  
  <div class="category-sidebar">
    <h3>Categories</h3>
    <nav class="category-list">
      {allCategories.map(cat => (
        <a 
          href={`${import.meta.env.BASE_URL}attributes/${cat}/`}
          class:list={['category-link', { active: cat === category }]}
        >
          {cat}
        </a>
      ))}
    </nav>
  </div>
  
  <div class="content">
    {stableAttributes.length > 0 && (
      <section class="attributes-section">
        <h2>Stable Attributes</h2>
        <div class="attribute-list">
          {stableAttributes.map(attr => (
            <AttributeCard attribute={attr.data} id={attr.id} />
          ))}
        </div>
      </section>
    )}
    
    {deprecatedAttributes.length > 0 && (
      <section class="attributes-section deprecated-section">
        <h2>Deprecated Attributes</h2>
        <p class="section-description">
          These attributes are deprecated and should not be used in new code. 
          See each attribute for migration guidance.
        </p>
        <div class="attribute-list">
          {deprecatedAttributes.map(attr => (
            <AttributeCard attribute={attr.data} id={attr.id} />
          ))}
        </div>
      </section>
    )}
  </div>
</BaseLayout>

<style>
  .breadcrumb {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    margin-bottom: var(--space-6);
  }
  
  .breadcrumb a {
    color: var(--color-text-secondary);
  }
  
  .breadcrumb a:hover {
    color: var(--color-accent);
  }
  
  .separator {
    color: var(--color-border-light);
  }
  
  .current {
    color: var(--color-text-primary);
  }
  
  .page-header {
    margin-bottom: var(--space-8);
  }
  
  .page-description {
    font-size: var(--text-lg);
    color: var(--color-text-secondary);
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-wrap: wrap;
  }
  
  .stat-stable {
    color: var(--color-pii-false);
  }
  
  .stat-deprecated {
    color: var(--color-text-muted);
  }
  
  .stat-separator {
    color: var(--color-text-muted);
  }
  
  .category-sidebar {
    position: fixed;
    left: max(calc((100vw - var(--max-width)) / 2 - 200px), var(--space-4));
    top: calc(var(--header-height) + var(--space-8));
    width: 160px;
    max-height: calc(100vh - var(--header-height) - var(--space-16));
    overflow-y: auto;
  }
  
  .category-sidebar h3 {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-3);
  }
  
  .category-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }
  
  .category-link {
    font-size: var(--text-sm);
    padding: var(--space-1) var(--space-2);
    color: var(--color-text-secondary);
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
  }
  
  .category-link:hover {
    background: var(--color-bg-hover);
    color: var(--color-text-primary);
  }
  
  .category-link.active {
    background: var(--color-accent-soft);
    color: var(--color-accent);
  }
  
  .content {
    display: flex;
    flex-direction: column;
    gap: var(--space-12);
  }
  
  .attributes-section h2 {
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-3);
    border-bottom: 1px solid var(--color-border);
  }
  
  .section-description {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    margin-bottom: var(--space-6);
  }
  
  .attribute-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }
  
  .deprecated-section {
    opacity: 0.9;
  }
  
  .deprecated-section h2 {
    color: var(--color-text-muted);
  }
  
  @media (max-width: 1400px) {
    .category-sidebar {
      display: none;
    }
  }
</style>
