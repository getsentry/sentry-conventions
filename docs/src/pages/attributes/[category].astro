---
import BaseLayout from '../../layouts/BaseLayout.astro';
import AttributeCard from '../../components/AttributeCard.astro';
import { getCollection } from 'astro:content';
import { parseAttributeId } from '../../utils/category';

export async function getStaticPaths() {
  const allAttributes = await getCollection('attributes');

  // Build category map
  const categoryMap = new Map<string, typeof allAttributes>();

  for (const attr of allAttributes) {
    const { category } = parseAttributeId(attr.id);
    
    if (!categoryMap.has(category)) {
      categoryMap.set(category, []);
    }
    categoryMap.get(category)!.push(attr);
  }
  
  // Generate paths for each category
  return Array.from(categoryMap.entries()).map(([category, attributes]) => ({
    params: { category },
    props: { attributes, allCategories: Array.from(categoryMap.keys()).sort() },
  }));
}

interface Props {
  attributes: Awaited<ReturnType<typeof getCollection<'attributes'>>>;
  allCategories: string[];
}

const { category } = Astro.params;
const { attributes, allCategories } = Astro.props;

// Sort attributes: stable first, then deprecated, both alphabetically
const stableAttributes = attributes
  .filter(a => !a.data.deprecation)
  .sort((a, b) => a.data.key.localeCompare(b.data.key));

const deprecatedAttributes = attributes
  .filter(a => a.data.deprecation)
  .sort((a, b) => a.data.key.localeCompare(b.data.key));

const totalCount = attributes.length;
const stableCount = stableAttributes.length;
const deprecatedCount = deprecatedAttributes.length;

// Format category name for display
const categoryTitle = category!.charAt(0).toUpperCase() + category!.slice(1);
---

<BaseLayout 
  title={`${categoryTitle} Attributes`} 
  description={`Browse ${totalCount} ${category} attributes in Sentry semantic conventions`}
>
  <div class="flex gap-8">
    <aside class="hidden lg:block flex-shrink-0 w-40 sticky top-[calc(64px+1.5rem)] max-h-[calc(100vh-64px-3rem)] overflow-y-auto self-start">
      <h3 class="text-sm text-text-muted uppercase tracking-wider mb-3">Categories</h3>
      <nav class="flex flex-col gap-1">
        {allCategories.map(cat => (
          <a 
            href={`${import.meta.env.BASE_URL}attributes/${cat}/`}
            class:list={[
              "text-sm px-2 py-1 rounded-sm transition-fast",
              cat === category
                ? "bg-accent-soft text-accent"
                : "text-text-secondary hover:bg-bg-hover hover:text-text-primary"
            ]}
          >
            {cat}
          </a>
        ))}
      </nav>
    </aside>
    
    <div class="flex-1 min-w-0">
      <nav class="breadcrumb">
        <a href={`${import.meta.env.BASE_URL}attributes/`}>Attributes</a>
        <span class="separator">/</span>
        <span class="current">{category}</span>
      </nav>
      
      <div class="mb-8">
        <h1>{categoryTitle} Attributes</h1>
        <p class="text-lg text-text-secondary flex items-center gap-2 flex-wrap">
          {totalCount} attribute{totalCount !== 1 ? 's' : ''} in this category.
          {stableCount > 0 && <span class="text-pii-false">{stableCount} stable</span>}
          {stableCount > 0 && deprecatedCount > 0 && <span class="text-text-muted">Â·</span>}
          {deprecatedCount > 0 && <span class="text-text-muted">{deprecatedCount} deprecated</span>}
        </p>
      </div>
      
      <div class="flex flex-col gap-12">
        {stableAttributes.length > 0 && (
          <section>
            <h2 class="mb-4 pb-3 border-b border-border">Stable Attributes</h2>
            <div class="flex flex-col gap-4">
              {stableAttributes.map(attr => (
                <AttributeCard attribute={attr.data} id={attr.id} />
              ))}
            </div>
          </section>
        )}
        
        {deprecatedAttributes.length > 0 && (
          <section class="opacity-90">
            <h2 class="mb-4 pb-3 border-b border-border text-text-muted">Deprecated Attributes</h2>
            <p class="text-sm text-text-muted mb-6">
              These attributes are deprecated and should not be used in new code. 
              See each attribute for migration guidance.
            </p>
            <div class="flex flex-col gap-4">
              {deprecatedAttributes.map(attr => (
                <AttributeCard attribute={attr.data} id={attr.id} />
              ))}
            </div>
          </section>
        )}
      </div>
    </div>
  </div>
</BaseLayout>
