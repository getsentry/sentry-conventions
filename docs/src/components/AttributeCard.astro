---
import PiiBadge from './PiiBadge.astro';
import TypeBadge from './TypeBadge.astro';
import type { Attribute } from '../content.config';

interface Props {
  attribute: Attribute;
  id: string;
  showCategory?: boolean;
}

const { attribute, id, showCategory = false } = Astro.props;

// Extract category from id (e.g., "http/http__request__method" -> "http")
const category = id.includes('/') ? id.split('/')[0] : 'general';
const slug = id.includes('/') ? id.split('/').slice(1).join('/') : id;
const isDeprecated = !!attribute.deprecation;
const detailUrl = `${import.meta.env.BASE_URL}attributes/${category}/${slug}/`;
---

<article 
  class:list={[
    'bg-bg-secondary border border-border rounded-lg p-5 transition-colors duration-fast scroll-mt-24 hover:border-border-light',
    { 'opacity-70 border-dashed hover:opacity-100': isDeprecated }
  ]} 
  id={attribute.key.replace(/\./g, '-').replace(/</g, '').replace(/>/g, '')}
  data-pagefind-body
>
  <div class="flex flex-wrap items-start justify-between gap-3 mb-3">
    <h3 class="flex items-center gap-2 text-base m-0" data-pagefind-meta="title">
      <a 
        href={detailUrl} 
        class="inline-flex items-center transition-colors duration-fast"
        aria-label={`View details for ${attribute.key}`}
        title="View attribute details"
      >
        <code class="text-base p-0 bg-transparent border-none text-accent transition-all duration-fast hover:text-accent-hover hover:underline hover:underline-offset-2" data-pagefind-index-attrs="data-key" data-key={attribute.key}>{attribute.key}</code>
      </a>
      {isDeprecated && <span class="badge badge-deprecated">Deprecated</span>}
    </h3>
    <div class="flex flex-wrap items-center gap-2">
      <TypeBadge type={attribute.type} />
      <PiiBadge pii={attribute.pii.key} reason={attribute.pii.reason} />
      {attribute.is_in_otel && (
        <span class="badge badge-otel" title="Defined in OpenTelemetry Semantic Conventions">OTel</span>
      )}
      {showCategory && (
        <a href={`${import.meta.env.BASE_URL}attributes/${category}/`} class="text-xs px-2 py-1 bg-bg-elevated rounded-sm text-text-muted hover:text-accent hover:bg-accent-soft">{category}</a>
      )}
    </div>
  </div>
  
  <p class="text-sm text-text-secondary mb-4 leading-relaxed">{attribute.brief}</p>
  
  <div class="flex flex-col gap-2">
    {attribute.example !== undefined && (
      <div class="flex items-baseline gap-3 text-sm">
        <span class="text-text-muted min-w-[100px] flex-shrink-0">Example</span>
        <code class="text-xs mr-1">{typeof attribute.example === 'object' ? JSON.stringify(attribute.example) : String(attribute.example)}</code>
      </div>
    )}
    
    {attribute.alias && attribute.alias.length > 0 && (
      <div class="flex items-baseline gap-3 text-sm">
        <span class="text-text-muted min-w-[100px] flex-shrink-0">Aliases</span>
        <span class="text-text-secondary">
          {attribute.alias.map((a) => <code class="text-xs mr-1">{a}</code>)}
        </span>
      </div>
    )}
    
    {attribute.has_dynamic_suffix && (
      <div class="flex items-baseline gap-3 text-sm">
        <span class="text-text-muted min-w-[100px] flex-shrink-0">Dynamic Suffix</span>
        <span class="text-text-secondary">Yes - the key contains dynamic parts</span>
      </div>
    )}
    
    {isDeprecated && (
      <div class="mt-3 p-3 bg-error/10 rounded-md border-l-[3px] border-error">
        {attribute.deprecation?.replacement ? (
          <p class="text-sm m-0">Use <code class="text-accent">{attribute.deprecation.replacement}</code> instead.</p>
        ) : (
          <p class="text-sm m-0">No replacement available at this time.</p>
        )}
        {attribute.deprecation?.reason && (
          <p class="mt-2 text-text-muted text-sm m-0">{attribute.deprecation.reason}</p>
        )}
      </div>
    )}
  </div>
  
  <a href={detailUrl} class="inline-flex items-center gap-1 mt-4 pt-3 border-t border-border text-sm text-text-muted transition-colors duration-fast hover:text-accent group">
    View details
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="transition-transform duration-fast group-hover:translate-x-[3px]">
      <path d="M5 12h14M12 5l7 7-7 7"/>
    </svg>
  </a>
</article>
